---
# Initial rollout is needed to configure dependencies

- include_vars: repositories.yml

- name: Creating deployment base dirs
  file: path=/opt/mindmaps
        state=directory

- name: Creating .ssh directory
  file: path=/home/denis/.ssh
        mode=0700
        owner=denis
        group=denis
        state=directory

- name: Installing deploy key
  copy: content={{ etl_key }}
        dest=/home/denis/.ssh/{{ etl_key_name }}
        mode=0600
        owner=denis
        group=denis

- name: Removing old instances of ETL repository
  file: path={{ etl_clone_dest }}
        state=absent

- name: Cloning ETL repository
  git: repo={{ etl_repository_url }}
       dest={{ etl_clone_dest }}
       clone=yes
       version={{ etl_branch }}
       accept_hostkey=yes
       key_file=/home/denis/.ssh/{{ etl_key_name }}
       bare=no
  async: 0
  poll: 20

- name: Installing Dependencies
  apt: name=maven
       state=present

- name: Setting etlsh password
  lineinfile: dest={{ etl_clone_dest }}/src/main/resources/application.properties
              regexp="shell.auth.simple.user.password=admin"
              line="shell.auth.simple.user.password={{ etlsh_password }}"
              state=present

- name: Starting ETL
  shell: "{{ etl_deploy_cmd }}"
  args:
    chdir: /home/denis/etl

