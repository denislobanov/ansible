---
# Set up LVM and LXC

- name: Installing tools
  apt: name={{ item }}
       update_cache=yes
       state=latest
  with_items:
      - "dmsetup"
      - "lvm2"
      - "lxc"
      - "libvirt-bin"
      - "bridge-utils"

- name: Setting up LVM physical volumes
  command: "pvcreate {{ lvm_pv }}"
  ignore_errors: yes

- name: Settung up LVM groups
  lvg: vg=lxc pvs={{ lvm_pv }}
  ignore_errors: yes

- name: Setting up LVM volumes
  lvol: lv={{ item }} 
        size={{ lvm_size }}
        state=present
  with_items:
    - "{{ containers }}"

- name: Creating file systems
  filesystem: dev=/dev/lxc/{{ item }} fstype={{ containers_fs }}
  with_items:
    - "{{ containers }}"

- name: Creating directories
  command: "mkdir -p /var/lib/lxc/{{ item }}/rootfs"
  with_items:
    - "{{ containers }}"
  ignore_errors: yes

- name: Mounting
  mount: name=/var/lib/lxc/{{ item }}/rootfs src=/dev/lxc/{{ item }} 

- name: Copying config files
  template: src=lxc-{{ item }}.conf dest=/var/lib/lxc/{{ item }}/config
  with_items:
    - "{{ containers }}"

- name: Copying fstab files
  template: src=lxc-{{ item }}.conf dest=/var/lib/lxc/{{ item }}/config
  with_items:
    - "{{ containers }}"

- name: Debootstrapping
  command: "debootstrap jessie /var/lib/lxc/{{ item }}/rootfs"
  with_items:
    - "{{ containers }}"

- name: Creating containers
  command: "lxc-create -n {{ item }} -t debian -f /var/lib/lxc/{{ item }}/config -B lvm --vgname lxc --fstype {{ containers_fs }} --fssize {{ lvm_size }}"
  with_items:
    - "{{ containers }}"

