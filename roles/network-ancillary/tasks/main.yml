---
# Set up network ancillary server

- name: Installing BIND9
  apt: name=bind9
       update_cache=yes
       state=latest

- name: Configuring BIND9
  copy: src={{ item  }} dest=/etc/bind/
  with_items: 
      - "{{ bind9_files }}"
  notify: restart bind9

- name: Removing previous install
  command: "{{ item }}"
  with_items:
      - "rm /opt/nexus"
      - "rm -rf /opt/{{ nexus_version }}"
      - "rm -rf /opt/sonatype-work"
      - "rm -rf /srv/nexus"
  ignore_errors: yes

- name: Installing Nexus
  unarchive: src={{ nexus_download_url }}
             dest=/opt/
             copy=yes

- name: Cleaning up
  file: path=/opt/sonatype-work
        state=absent

- name: Configuring Nexus
  copy: src=nexus.properties dest=/opt/{{ nexus_version }}/conf/

- name: Creating nexus user group
  group: name=nexus
         system=yes
         state=present

- name: Creating nexus user
  user: name=nexus
        group=nexus
        shell=/bin/bash
        home=/srv/nexus
        system=yes
        state=present

- name: Setting up working environment
  file: path={{ item }}
        owner=nexus
        group=nexus
        state=directory
  with_items:
    - "/srv/nexus"
    - "/opt/{{ nexus_version }}"

- name: Creating /opt/nexus symlink
  file: src=/opt/{{ nexus_version }} dest=/opt/nexus
        owner=nexus
        group=nexus
        state=link

- name: Copying init script
  copy: src=nexus 
        dest=/etc/init.d/
        mode=0755

- name: Updating rc.d
  command: "update-rc.d nexus defaults"
  notify: start nexus

